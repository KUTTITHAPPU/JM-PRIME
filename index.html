import streamlit as st
from fpdf import FPDF
from streamlit_mic_recorder import speech_to_text
import base64
from datetime import datetime

# --- 1. BRAND ARCHITECTURE & CSS ---
st.set_page_config(page_title="JM PRIME | Precision Neural Engine", layout="wide")

def local_css():
    st.markdown("""
        <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;900&display=swap');
        
        /* Global Background */
        .stApp { background-color: #0d1117; color: #e6edf3; font-family: 'Inter', sans-serif; }
        
        /* 3D ENGINE LOGO ANIMATION */
        .engine-container { display: flex; flex-direction: column; align-items: center; padding: 10px; }
        .gear-outer {
            width: 70px; height: 70px; border: 2px dashed #8b949e; border-radius: 50%;
            position: relative; animation: spin-slow 12s linear infinite; opacity: 0.4;
        }
        .jm-core {
            position: absolute; top: 20px; font-weight: 900; 
            font-size: 22px; color: #007AFF; animation: counter-spin 4s ease-in-out infinite;
            text-shadow: 0 0 15px rgba(0, 122, 255, 0.5);
        }
        @keyframes spin-slow { from {transform: rotate(0deg);} to {transform: rotate(360deg);} }
        @keyframes counter-spin { 0%, 100% {transform: rotate(0deg) scale(1);} 50% {transform: rotate(-180deg) scale(1.1);} }

        /* BRANDING */
        .brand-header { text-align: center; margin-bottom: 20px; }
        .brand-header h1 { font-weight: 900; letter-spacing: 3px; margin: 0; font-size: 2.5rem; }
        .brand-header span { font-weight: 200; color: #007AFF; letter-spacing: 8px; }
        
        /* NEURAL INPUT BOX */
        .stTextArea textarea {
            background-color: #161b22 !important;
            border: 1px solid rgba(255,255,255,0.1) !important;
            color: #ffffff !important;
            border-radius: 15px !important;
        }
        </style>
    """, unsafe_allow_html=True)

local_css()

# --- 2. LOGIC HELPERS ---
def create_pdf(text):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", 'B', 16)
    pdf.cell(200, 10, txt="JM PRIME | PRECISION RECORD", ln=True, align='C')
    pdf.set_font("Arial", size=12)
    pdf.ln(10)
    pdf.multi_cell(0, 10, txt=f"Timestamp: {datetime.now()}\n\nContent:\n{text}")
    return pdf.output(dest='S').encode('latin-1')

# --- 3. HEADER & LOGO ---
st.markdown("""
    <div class="engine-container">
        <div class="gear-outer"></div>
        <div class="jm-core">JM</div>
    </div>
    <div class="brand-header">
        <h1>JM <span>PRIME</span></h1>
        <p style="color: #8b949e; font-size: 10px; letter-spacing: 4px; text-transform: uppercase;">Precision Neural Engine v1.0</p>
    </div>
""", unsafe_allow_html=True)

# --- 4. THE NEURAL BRIDGE (MAIN UI) ---
col1, col2 = st.columns([2, 1])

with col1:
    st.markdown("### üõ∞Ô∏è SOURCE NODE")
    
    # Neural Voice Integration
    st.write("Voice Input:")
    text_from_voice = speech_to_text(language='en', start_prompt="‚è∫ START NEURAL MIC", stop_prompt="‚èπ SYNC VOICE", key='STT')
    
    # Text Input (Overrides voice if typed)
    input_text = st.text_area("", value=text_from_voice if text_from_voice else "", height=200, placeholder="Awaiting input for precision analysis...")
    
    if st.button("EXECUTE NEURAL BRIDGE", use_container_width=True):
        if input_text:
            st.toast("Neural Bridge Established...")
            st.success(f"PROCESSED: {input_text}")
        else:
            st.warning("Input required for initialization.")

with col2:
    st.markdown("### ‚öôÔ∏è SYSTEM ACTIONS")
    
    # Export PDF Logic
    if input_text:
        pdf_data = create_pdf(input_text)
        st.download_button(
            label="üìÑ EXPORT PDF RECORD",
            data=pdf_data,
            file_name=f"JM_PRIME_LOG_{datetime.now().strftime('%Y%m%d')}.pdf",
            mime="application/pdf",
            use_container_width=True
        )
    
    # Status Indicators
    st.markdown("---")
    st.metric(label="System Status", value="OPTIMAL", delta="99.8% ACC")
    st.info("Target: ML (Malayalam)\nPrecision: High-Standard")

st.markdown("<br><hr><center style='color:#444; font-size:10px;'>JM PRIME | 2026 THRISSUR NODE</center>", unsafe_allow_html=True)
